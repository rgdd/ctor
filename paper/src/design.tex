\section{Design}
Figure~\ref{fig:overview} provides an overview of our design idea.  The starting
point is that zero or more certificate chains and SCTs are presented
throughout a website visit (step~1).  We refer to these as SCT Feedback Objects
(SFOs)~\cite{nordberg}.  Tor Browser accepts an SFO if it adheres to an
SCT-centric CT policy similar to Chrome and Safari~%
\cite{chrome-policy,safari-policy}, but it may also be submitted to a CTR
in the background using a fresh independent circuit (step~2).  CTR flags are
assigned by Tor's directory authorities, and among other things, they also
determine Tor's view of the CT landscape by publishing STHs and announcing
third-party CT auditors in the Tor consensus.  CTRs store SFOs temporarily
before challenging the logs to prove inclusion with regards to Tor's published
STHs (step~3).  Should a log fail to provide a valid inclusion proof for an SFO
within a timely manner, it is reported to an auditor that investigates the issue
further (step~4).
\begin{figure}
	\centering
	\input{img/overview}
	\caption{%
		TODO: docdoc, and label ORs?
	}
	\label{fig:overview}
\end{figure}

\subsection{Tor Consensus}
Tor's directory authorities produce an hourly consensus document that defines
how the Tor network is composed.  Our proposal further requires the following
parameters:
\begin{description}
	\item[ct-get-sth:] Occurs multiple times.  Log ID, followed by an STH that is
		formatted as returned by the log's \texttt{get-sth}
		endpoint~\cite{ct,ct/bis}.
	\item[ct-submit-pr:] Occurs exactly once.  A floating-point in $[0,1]$
		that determines the probability that an SFO should be submitted from Tor
		Browser to a CTR.
	\item[ct-query-timeout:] Occurs exactly once.  A natural number that
		determines how many ms a CTR waits before concluding that a CT log is
		unresponsive.
	\item[ct-backoff:] Occurs exactly once.  A natural number that determines
		how many ms a CTR backs-off at most while auditing SFOs for inclusion.
		Note that this is the upper bound of a uniform distribution.
	\item[ct-auditor:] Occurs multiple times.  A submission URI, followed by a
		SPKI hash that must be present in the TLS certificate presented by the
		auditor~\cite{hpkp}.
\end{description}

Throughout any given voting timeline, each directory authority is expected to
obtain the most recent STH from all recognized CT logs.  Next, while computing
the consensus, they must agree to use the most recent STH by inspecting the
timestamp field and resolving ties by appealing to lexicographical
order.\footnote{%
	Note that there is cryptographic proof of log misbehaviour if two STHs with
	the same tree size have different root hashes.
}  A log is recognized and a proposed CT auditor is announced if a majority of
all directory authorities voted on their inclusion, which is implicit by
proposing a value.  The submit probability, query timeout, and CTR back-off
parameters are all computed as the median values of the respective votes.

Other than the new parameters introduced above, we also need to extend the
\texttt{know-flags} parameter as described below.  A relay is assigned the CTR
flag if a majority of directory authorities voted for it.
\begin{description}
	\item[known-flags:] A flag named \texttt{CTR}, which indicates
		that a Tor relay should be used for CT-auditing purposes.  The CTR
		criteria is to be a stable middle relay with some minimum bandwidth.
		\TODO{bw necessary?}
\end{description}
% - A CTR should be stable both to permit long-lived circuits to the CT logs and
% to increase the likelihood of them staying online.
% - The criteria of being a middle relay, as opposed to an exit relay, follows
% mainly from resource utilization considerations.  It is also about not making
% exit relays "more attractive targets" due to also storing SFOs.

\subsection{Tor Browser}
Similar to Chrome and Safari~\cite{chrome-policy,safari-policy}, we suggest that
Tor Browser should use an SCT-centric CT policy.  This means that a certificate
chain is accepted as valid if it is accompanied by a threshold of SCTs.  Such a
policy would ideally come from Mozilla directly (like many other components),
but at the time of writing there is no official CT policy that can be inherited
from Firefox.

If an SFO passes Tor Browser's CT policy, a biased coin is flipped based on the
current value of \texttt{ct-submit-pr}.  Should the outcome indicate auditing,
a CTR is sampled uniformly from the set of available CTRs and then the SFO is
submitted on a fresh independent circuit that is closed as soon as possible.  In
other words, at most one SFO is submitted per circuit.  In case that an SFO is
presented multiple times within the same tab, it is only considered for auditing
once.

%
% - close circuit asap to make it harder for an attacker to figure out which
% CTR received a submission (should it have access to a zero-day takeover).
% - clearly a submission circuit cannot be reused across tabs, but not doing
% so within tabs may (i) reduce the chance that the receiving CTR knows exactly
% which website was visited, and (ii) make sense because with small submission
% pr (<=1/10) it should be common to submit at most once per tab anyway.
%

\subsection{CTR}
A relay that is assigned the CTR flag accepts incoming SFO submissions on a
dedicated HTTP endpoint.  As such, we suggest using Tor's existing HTTP
DirServer as an extension point to interact with the tor daemon.  An auditing
process then runs somewhat periodically, ensuring that the received SFOs are
either merged into the logs or given attention to by the announced auditors.
Following from the threat of flushing, CTRs also publish additional health
metrics in the extra-info document.

\subsubsection{Submission Endpoint}
As outlined in detail below, a CTR listens for incoming SFO submissions on an
HTTP endpoint.  For example, it is possible to reuse the SCT feedback mechanism
that Nordberg~\emph{et~al.} defined~\cite{nordberg}.  At most one SFO is
expected per circuit.  Therefore, a submission should be rejected if it
contains more than one SFO (step~\ref{enm:ctr-api:incoming}).
A CTR should also reject a submission if it contains no SCT from a recognized CT
log, as there would be no STH available in the Tor consensus to use while
querying for inclusion (step~\ref{enm:ctr-api:well-formed}).
If an SFO corresponds to a frequently visited website, it might already be
resolved or waiting to be resolved in a \emph{cache} or a \emph{buffer} of
pending SFOs (step~\ref{enm:ctr-api:cached}).
Both the cache and the buffer of pending SFOs should be managed by Tor's OOM,
which takes care of similar resources such as DNS.  If an SFO is neither
resolved nor waiting to be resolved, an \texttt{audit\_after} timestamp $t$ is
computed (step~\ref{enm:ctr-api:audit-after}).
Unless the current time is greater than $t$, the SFO in question will not be
audited despite being stored in the buffer of pending SFOs
(step~\ref{enm:ctr-api:store}).
The reason why an SFO is not audited immediately is two-fold.  First, adding a
random delay in the order of minutes makes it harder for the log to learn about
real-time website visits.  Secondly, a log is not forced to add an SCT's entry
unless an MMD elapsed (see Section~\ref{sec:todo}).

For each incoming SFO $s$:
\begin{enumerate}
	\item\label{enm:ctr-api:incoming} Return and error and stop if some SFO was
		already received over the current circuit.
	\item\label{enm:ctr-api:well-formed} Return an error and stop if $s$
		contains no SCT from a recognized log.  Unrecognized SCTs are dropped.
		% otherwise can exploit for flush
	\item\label{enm:ctr-api:cached} Check if $s$ is already cached or pending
		inclusion verification.  If so, discard $s$ and stop without error.
	\item\label{enm:ctr-api:audit-after} Select the first SCT in $s$ using
		lexicographical order and compute an \texttt{audit\_after} timestamp
		(Figure~\ref{fig:audit-after}).
	\item\label{enm:ctr-api:store} Store $s$ and its \texttt{audit\_after}
		timestamp in a buffer of pending SFOs that is managed by Tor's OOM.
\end{enumerate}

If memory becomes a scarce resource due to flushing, OOM should trigger and
delete SFOs at random~\cite{nordberg}.  The impact of such bulk-deletes
are discussed in Section~\ref{sec:todo}.

\begin{figure}
	\centering
	\pseudocode[linenumbering, syntaxhighlight=auto]{%
		\textrm{t} \gets \mathsf{now}() \\
		\pcif \textrm{SCT.timestamp} + \textrm{MMD} >
				\textrm{t}:\\
			\pcind\textrm{t} \gets \mathsf{min}(
				\textrm{SCT.timestamp}, \textrm{t} +
				\textrm{MMD}
			)\\
			\textrm{t} \gets \textrm{t} + \mathsf{random\_delay}()
	}
	\caption{%
		Algorithm that computes an \texttt{audit\_after} timestamp.
	}
	\label{fig:audit-after}
\end{figure}


\subsubsection{Auditing Process}
TODO: add context
\begin{enumerate}
	\item\label{enm:backoff} Sample a uniform delay from
			$[0, \texttt{ct-backoff}]$, then
		schedule a timer and wait until that time elapsed.
	\item\label{enm:audit-circuit} Establish a new circuit and connect to a
		randomly selected announced auditor in the Tor consensus.
	\item\label{enm:log-circuit} Establish a new circuit and use it for all
		subsequent log connections.  Connect to the logs when needed.
	\item\label{enm:audit-loop} Until there are no more SFOs such that their
		\texttt{audit\_after} timestamps are less than $\mathsf{now}()$:
		\begin{enumerate}
			\item Select a random SCT from the current SFO.
			\item Disregard this SFO until the next wake-phase if there is no
				most recent STH available such that $\textrm{STH.timestamp} +
				\textrm{MMD} \ge
					\textrm{SCT.timestamp}$.
			\item Use the most recent Tor consensus to set a query-timeout and
				challenge the log to prove inclusion with regards to the
				announced STH.
				\begin{itemize}
					\item On valid proof: cache the SFO in question by storing
						the first SCT in lexicographical order hashed using a
						cryptographic hash function, then continue the loop from
						step~\ref{enm:audit-loop}.
					\item On any other outcome: immediately send the entire SFO
						to the auditor from step~\ref{enm:audit-circuit}, then
						remove it from the buffer and break.
				\end{itemize}
		\end{enumerate}
	\item Close all circuits from steps~\ref{enm:audit-circuit}--%
		\ref{enm:log-circuit} and go to step~\ref{enm:backoff}.
\end{enumerate}

\subsubsection{Extra-Info Document}
The extra-info document tells us something about a relay's internal state of
affairs.  For example, \texttt{read-history} and \texttt{write-history} list how
many bytes were consumed throughout different time intervals.  To detect
flushing attempts and track CT overhead in Tor, we suggest that the following
metrics should be added:
\begin{description}
	\item[ct-submit-bytes:] Occurs at most once.  Interval width, followed by a
		list of received SFO bytes per interval.
	\item[ct-submit-count:] Occurs at most once.  Interval width, followed by a
		list of received SFO submission counts per interval.
	\item[ct-delete-count:] Occurs at most once.  Interval width, followed by a
		list of deleted SFO submissions per interval.
\end{description}

A CTR should generate a new descriptor and extra-info document if the most
current extra-info document had no deletions while the next one will have more
than a threshold.  This is \emph{in addition} to already existing criteria.

\subsection{Announced Auditors}
An announced auditor is expected to implement the SCT feedback interface of
Nordberg~\emph{et~al.}~\cite{nordberg}.  If a well-formed SFO is received, the
auditor in question should endeavor to validate the inclusion status of each SCT
with regards to the first STH in the Tor consensus that elapsed the log's MMD.
Like any interested party, an announced auditor can and should verify that all
STHs in the Tor consensus are consistent by fetching such proofs.

% TODO: two-component system??
If the log appears to function correctly except for some evidence that cannot be
resolved despite multiple attempts that span a given time period, the auditor
software must alert its operator.  More precisely:
\begin{itemize}
	\item If the log fails to provide a valid inclusion proof for an SCT with
		regards to the first applicable STH in the Tor consensus
		(an MMD violation is suspected).
	\item If the log fails to provide a valid consistency proof between any two
		STHs in the Tor consensus
		(a split-view is suspected within the Tor network).
	\item If an STH in the Tor consensus exceeds the log's MMD (general log
		misbehaviour is suspected).
\end{itemize}

An announced auditor may choose to replicate possible evidence of log
misbehaviour to the other announced auditors prematurely to ensure that
it is persisted beyond its own durable storage.  At some point, the auditor
software should generate a complete report that can be forwarded by the
auditor's operator to the CT-policy mailing list for further community
investigation.
