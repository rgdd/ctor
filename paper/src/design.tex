\section{Design}
\label{sec:design}
Figure~\ref{fig:overview} provides an overview of our design idea.  The starting
point is that zero or more certificate chains and SCTs are presented
throughout a website visit (step~1).  We refer to these as SCT Feedback Objects
(SFOs)~\cite{nordberg}.  Tor Browser accepts an SFO if it adheres to an
SCT-centric CT policy similar to Chrome and Safari~%
\cite{chrome-policy,safari-policy}, but it may also be submitted to a CTR
in the background using a fresh independent circuit (step~2).  CTR flags are
assigned by Tor's directory authorities, and among other things, they also
determine Tor's view of the CT landscape by publishing STHs and announcing
third-party CT auditors in the Tor consensus.  CTRs store SFOs temporarily
before challenging the logs to prove inclusion with regards to Tor's published
STHs (step~3).  Should a log fail to provide a valid inclusion proof for an SFO
within a timely manner, it is reported to an auditor that investigates the issue
further (step~4).
\begin{figure}
	% TODO: clarify circuit structure to CTR in the overview figure?
	\centering
	\input{img/overview}
	\caption{%
		Design overview---Tor Browser submits presented SFOs to CTRs that follow
		up on their inclusion statuses.  Entity-to-entity interactions are
		conveyed over full Tor circuits, labeled by onions.
	}
	\label{fig:overview}
\end{figure}

\subsection{Tor Consensus}
Tor's directory authorities produce an hourly consensus document that defines
how the Tor network is composed.  Our proposal adds the following parameters,
further explained throughout Section~\ref{sec:design}:
\begin{description}
	\item[ct-get-sth:] Occurs multiple times.  Log ID, followed by an STH that is
		formatted as returned by the log's \texttt{get-sth}
		endpoint~\cite{ct,ct/bis}.
	\item[ct-submit-pr:] Occurs exactly once.  A floating-point in $[0,1]$
		that determines the probability that an SFO should be submitted from Tor
		Browser to a CTR.
	\item[ct-query-timeout:] Occurs exactly once.  A natural number that
		determines how many ms a CTR waits before concluding that a CT log is
		unresponsive.
	\item[ct-submit-timeout:] Occurs exactly once.  A natural number that
		determines how many ms Tor Browser waits before concluding that a CTR
		is unresponsive.
	\item[ct-report-timeout:] TODO: docdoc
	\item[ct-report-count:] TODO: docdoc
	\item[ct-backoff:] Occurs exactly once.  A natural number that determines
		how many ms a CTR backs-off at most while auditing SFOs for inclusion.
		Note that this is the upper bound of a uniform distribution.
	\item[ct-auditor:] Occurs multiple times.  A submission URI, followed by a
		SPKI fingerprint that must be present in the TLS certificate presented
		by the auditor~\cite{hpkp}.
\end{description}

Throughout any given voting timeline, each directory authority is expected to
obtain the most recent STH from all recognized CT logs.  Next, while computing
the consensus, they must agree to use the most recent STH by inspecting the
timestamp field and resolving ties by appealing to lexicographical
order.\footnote{%
	Note that there is cryptographic proof of log misbehaviour if two STHs with
	the same tree size have different root hashes.
}  A log is recognized and a proposed CT auditor is announced if a majority of
all directory authorities voted on their inclusion, which is implicit by
proposing a value.  The submit probability, query timeout, and CTR back-off
parameters are all computed as the median values of the respective votes.

Other than the new parameters introduced above, we also need to extend the
\texttt{know-flags} parameter by adding a CTR-flag.  The CTR-flag is 
assigned to stable middle relays if a majority of directory authorities voted
for it, and it indicates that a given Tor relay should take on the additional
responsibility of auditing CT logs.

% - A CTR should be stable both to permit long-lived circuits to the CT logs and
% to increase the likelihood of them staying online.
% - The criteria of being a middle relay, as opposed to an exit relay, follows
% mainly from resource utilization considerations.  It is also about not making
% exit relays "more attractive targets" due to also storing SFOs.

\subsection{Tor Browser}
Similar to Chrome and Safari~\cite{chrome-policy,safari-policy}, we suggest that
Tor Browser should use an SCT-centric CT policy.  This means that a certificate
chain is accepted as valid if it is accompanied by a threshold of SCTs.  Such a
policy would ideally come from Mozilla directly (like many other components),
but at the time of writing there is no official CT policy that can be inherited
from Firefox.

If an SFO passes Tor Browser's CT policy, the value of
\texttt{ct-submit-pr} is used to flip a biased coin.  The outcome determines
whether further inclusion verification should take place, in which case the SFO
is submitted to a sampled CTR over a fresh independent circuit
that is \emph{pre-built} from the client's guard relay (three hops in total) 
and closed immediately after use.  In other words, Tor Browser should maintain a
pool of one-time circuits that are used for CT-auditing purposes only.
Should the same SFO be presented multiple times within the same tab, it is only
considered for further auditing on a \emph{first-encounter} basis.
If a submitted SFO is unacknowledged after some maximum time as decided by
\texttt{ct-submit-timeout}, it is resubmitted as if there was no failure to
begin with:
	use another pre-built circuit to a sampled CTR.
This ensures that Tor Browser does not keep submitting to a CTR that is no
longer available, while at the same time having limited security impact.

%
% - close circuit asap to make it harder for an attacker to figure out which
% CTR received a submission (should it have access to a zero-day takeover).
% - clearly a submission circuit cannot be reused across tabs, but not doing
% so within tabs may (i) reduce the chance that the receiving CTR knows exactly
% which website was visited, and (ii) make sense because with small submission
% pr (<=1/10) it should be common to submit at most once per tab anyway.
% - resubmission:
%   a) new circuit because the exit might be attacker controlled and
%   intentionally be blocking access to a CTR that is not attacker-controlled
%   b) new ctr because we don't wanna keep on trying indefinitely if there is
%   an actual problem with the selected ctr.  At the same time, it will be
%   difficult for the attacker to rely on Tor Browser never sampling both a
%   benign exit and ctr (in which case the submission should succeed).
%
% TODO: should pre-built CT-circuits be connected to CTRs before use?  It
% would be good to minimize submit window, but overhead cost unclear atm.

\subsection{CTR}
A relay that is assigned the CTR flag accepts incoming SFO submissions on a
dedicated endpoint.  Somewhat periodically, an auditing process then runs which
verifies the inclusion status of SFOs that are pending.  CTRs also
publish health metrics in the extra-info document.

\subsubsection{Submission Endpoint} \label{sec:design:api}
We suggest that CTRs accept SFO submissions on an HTTP endpoint.\footnote{%
	Tor's HTTP DirServer codebase can be reused as extension point to interact
	with the tor daemon, i.e., add another listener.
} For example, Nordberg~\emph{et~al.} defined an SCT feedback interface that can
be reused if an array-length of one is enforced by the CTR~\cite{nordberg}.
With regards to some circuit, process an incoming SFO $s$ as follows:
\begin{enumerate}
	\item\label{enm:ctr-api:well-formed} Close the circuit and stop if $s$
		contains no SCT that matches at least one log ID in a
	\texttt{ct-get-sth} entry.
	\item\label{enm:ctr-api:ack} Update $s$ by discarding any
		unrecognized SCT, % otherwise can exploit for easier flush
		then acknowledge the reception and close the circuit.
	\item\label{enm:ctr-api:cached}
		Stop if $s$ is cached or pending inclusion verification.
	\item\label{enm:ctr-api:audit-after} Sample an SCT in $s$, noting down the
		outcome and a corresponding \texttt{audit\_after} timestamp
		(Figure~\ref{fig:audit-after}).
	\item\label{enm:ctr-api:store} Store $s$ and its \texttt{audit\_after}
		timestamp in a buffer of pending SFOs that is managed by Tor's OOM.
\end{enumerate}

First we verify that the submitted SFO is well-formed and that it contains at
least one SCT that corresponds to an STH in the Tor consensus.
Possibly preceded by an acknowledgment that the SFO will be audited, the
associated circuit is then closed.  This means that no acknowledgment should be
treated as an error, and at most one SFO can be submitted on a given circuit.
New SFOs, i.e., SFOs that are neither \emph{cached} nor waiting to be resolved
in a \emph{buffer} of pending SFOs, are stored.  We only keep recognized
SCTs around to ensure that no CTR memory is wasted, and one of these SCTs are
sampled so that an \texttt{audit\_after} timestamp can be computed.  The
\texttt{audit\_after} timestamp determines the earliest point in time that an
SFO will be considered for auditing:
	a random delay is added to leak less real-time information regarding visited
		websites to the CT logs, and
	by auditing after an SCT's MMD elapsed the log \emph{must} have an
		inclusion proof available or it misbehaves.

If memory becomes a scarce relay resource, e.g., due to flushing, OOM
should delete SFOs at random~\cite{nordberg}.  The impact of such bulk-deletes
are discussed in Section~\ref{sec:todo}.

\begin{figure}
	\centering
	\pseudocode[linenumbering, syntaxhighlight=auto]{%
		\textrm{t} \gets \mathsf{now}() \\
		\pcif \textrm{SCT.timestamp} + \textrm{MMD} >
				\textrm{t}:\\
			\pcind\textrm{t} \gets \mathsf{min}(
				\textrm{SCT.timestamp}, \textrm{t} +
				\textrm{MMD}
			)\\
			\textrm{t} \gets \textrm{t} + \mathsf{random\_delay}()
	}
	\caption{%
		Algorithm that computes an \texttt{audit\_after} timestamp that is
		bound by the CTR's perception of time and the log's MMD.
	}
	\label{fig:audit-after}
\end{figure}


\subsubsection{Auditing Process}
CTR auditing is initiated at random time intervals to spread out the load
imposed by the Tor network on CT logs.  Each auditing instance is composed of
circuit setup, a core loop of SFO enumeration, and circuit tear-down.

\begin{enumerate}
	\item\label{enm:backoff} Sample a uniform delay from
			$[0, \texttt{ct-backoff}]$,
		then schedule a timer and wait until that time elapsed.
	\item\label{enm:audit-circuit} Establish a new circuit and connect to a
		randomly selected auditor in the Tor consensus.  Test that the
		auditor is available by submitting a dummy-SFO using
		\texttt{ct-report-timeout}.  If not, close the circuit and repeat this
		step at most \texttt{ct-report-count} times.
	\item\label{enm:log-circuit} Establish a new circuit and use it for all
		subsequent log connections.  Connect to the logs when needed.
	\item\label{enm:audit-loop} Enumerate the set of pending SFOs, referring to
		the SCTs in Section~\ref{sec:design:api},
		step~\ref{enm:ctr-api:audit-after}, and their logs' STHs:
		\begin{enumerate}
			\item\label{enm:audit-loop:wait-sct} Continue if
				$\textrm{SFO}.\mathsf{audit\_after} > \mathsf{now}()$.
			\item\label{enm:audit-loop:wait-sth} Continue if
				$\textrm{SFO}.\mathsf{audit\_after} >
				\textrm{STH}.\mathsf{timestamp}$.
			\item\label{enm:audit-loop:challenge}
				Use \texttt{ct-query-timeout} and
				$\textrm{STH}.\mathsf{treesize}$ to set a timer and challenge
				the log to prove inclusion.
				\begin{itemize}
					\item\label{enm:audit-loop:challenge:success} On valid
						proof: cache the SFO in question by storing a hashed
						representation.
					\item\label{enm:audit-loop:challenge:fail} On any other
						outcome: use \texttt{ct-report-timeout} to set a timer
						and send the entire SFO to the auditor in
						step~\ref{enm:audit-circuit}.  On any failure, log $s$
						to torlog and re-report it:
						\begin{itemize}
							\item Sample \texttt{ct-report-count}
								auditors and resubmit $s$ on (new) separated
								circuits.
							\item Sample \texttt{ct-report-count} CT logs not
								referred by $s$ and submit the underlying
								certificate chain via \texttt{add-chain}~\cite{ct}
								or \texttt{submit-entry}~\cite{ct/bis}
								on separated circuits.
						\end{itemize}
						Finally, discard the SFO and break the loop.
				\end{itemize}
		\end{enumerate}
	\item\label{enm:teardown} Close all opened circuits and go back to
		step~\ref{enm:backoff}.
\end{enumerate}

Keeping auditor and log interactions separate is good circuit hygiene in
general.  For example,  sharing these circuits would allow the attacker to
identify which exit relay should be DoS:ed to delay an auditor submission.
In the core loop, we only audit an SFO's sampled SCT if its MMD elapsed
and there is an STH available in the Tor consensus that captures it.  Note that
the full SFO is always reported on failure, which ensures that the auditors can
validate all SCTs further.  If an auditor becomes unavailable, we take several
actions to increase the likelihood that an SFO and/or its underlying certificate
chain makes it into the public domain.  Namely, resubmit to several auditors,
log it locally to torlog, and submit the underlying certificate chain for
merging into independent CT logs that the attacker may not control.

% where sth first after mmd elapsed !  Missing right now
% - not necessary, let auditor bother with that
%
% Remember: audit sampled sct -> less overhead, less info leak to ct logs
%

\subsubsection{Extra-Info Document}
The extra-info document tells us something about a Tor relay's internal state of
affairs.  For example, \texttt{read-history} and \texttt{write-history} list how
many bytes were consumed throughout different time intervals.  We further
require that the following metrics be added:
\begin{description}
	\item[ct-receive-bytes:] Occurs at most once.  Interval width, followed by a
		list of received SFO bytes per interval.
	\item[ct-delete-bytes:] Occurs at most once.  Interval width, followed by a
		list of deleted SFO bytes per interval.
\end{description}

A CTR should generate a new descriptor and extra-info document if the most
current extra-info document had no deletions while the next one will have at
least one deletion:
	this enables \emph{early detection} of flushing-related activities
	(or suspicion thereof).
There are other health-related metrics that could be added in the
extra-info document, such as
	the number of SFO submissions and deletions,
	the ratio between SFOs that are younger than an MMD, and
	per-log failure rates while querying for inclusion.
The latter, for example, could be used as an indicator that the current
query-timeout is too optimistic.

\subsection{Announced Auditors}
An announced auditor is expected to implement the SCT feedback interface of
Nordberg~\emph{et~al.}~\cite{nordberg}.  If a well-formed SFO is received, the
auditor in question should endeavor to validate the inclusion status of each SCT
with regards to the first STH in the Tor consensus that elapsed the log's MMD.
An announced auditor should also verify that each STH in the Tor consensus is
in fact consistent by fetching consistency proofs from the logs.
While not within our threat model, we do encourage the announced auditors to
verify that STHs in the Tor consensus are consistent with external views of the
CT landscape.  For example, operate an STH pollination~\cite{nordberg} endpoint
and fetch STHs actively from many diverse vantage points using Tor, VPN
services, DoH resolvers, and RIPE Atlas (to mention a few low-cost options).

% TODO: two-component system??
If the log appears to function correctly except for some evidence that cannot be
resolved despite multiple attempts that span a given time period, it is
paramount that the auditor software alerts its operator.  In detail:
\begin{itemize}
	\item If the log fails to provide a valid inclusion proof for an SCT with
		regards to the first applicable STH in the Tor consensus
		(an MMD violation is suspected).
	\item If the log fails to provide a valid consistency proof between any two
		STHs in the Tor consensus
		(a split-view is suspected within the Tor network).
	\item If an STH in the Tor consensus is future-dated or backdated more than
		an MMD (general log misbehavior suspected).
\end{itemize}

An announced auditor may choose to replicate possible evidence of log
misbehaviour to the other announced auditors prematurely to ensure that
it is persisted beyond its own durable storage.  At some point, the auditor
software should generate a complete report that can be forwarded by the
auditor's operator to the CT-policy mailing list for further community
investigation.
