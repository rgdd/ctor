\section{Design}
Figure~\ref{fig:overview} provides an overview of our design idea.  The starting
point is that zero or more certificate chains and SCTs are presented
throughout a website visit (step~1).  We refer to these as SCT Feedback Objects
(SFOs)~\cite{nordberg}.  Tor Browser accepts an SFO if it adheres to an
SCT-centric CT policy similar to Chrome and Safari~%
\cite{chrome-policy,safari-policy}, but it may also be submitted to a CTR
in the background using a fresh independent circuit (step~2).  CTR flags are
assigned by Tor's directory authorities, and among other things, they also
determine Tor's view of the CT landscape by publishing STHs and announcing
third-party CT auditors in the Tor consensus.  CTRs store SFOs temporarily
before challenging the logs to prove inclusion with regards to Tor's published
STHs (step~3).  Should a log fail to provide a valid inclusion proof for an SFO
within a timely manner, it is reported to an auditor that investigates the issue
further (step~4).
\begin{figure}
	\centering
	\input{img/overview}
	\caption{%
		TODO: docdoc, and label ORs?
	}
	\label{fig:overview}
\end{figure}

\subsection{Tor Consensus}
Tor's directory authorities produce an hourly consensus document that defines
how the Tor network is composed.  Our proposal further requires the following
parameters:
\begin{description}
	\item[ct-get-sth:] Occurs multiple times.  Log ID, followed by an STH that is
		formatted as returned by the log's \texttt{get-sth}
		endpoint~\cite{ct,ct/bis}.
	\item[ct-submit-pr:] Occurs exactly once.  A floating-point in $[0,1]$
		that determines the probability that an SFO should be submitted from Tor
		Browser to a CTR.
	\item[ct-auditor:] Occurs multiple times.  A submission URI, followed by a
		SPKI hash that must be present in the TLS certificate presented by the
		auditor~\cite{hpkp}.
\end{description}

Throughout any given voting timeline, each directory authority is expected to
obtain the most recent STH from all recognized CT logs.  Next, while computing
the consensus, they must agree to use the most recent STH by inspecting the
timestamp field and resolving ties by appealing to lexicographical
order.\footnote{%
	Note that there is cryptographic proof of log misbehaviour if two STHs with
	the same tree size have different root hashes.
}  A log is recognized and a proposed CT auditor is announced if a majority of
all directory authorities voted on their inclusion, which is implicit by
proposing a value.  The submit probability is computed as
the median of all votes.

Other than the new parameters introduced above, we also need to extend the
\texttt{know-flags} parameter as described below.  A relay is assigned the CTR
flag if a majority of directory authorities voted for it.
\begin{description}
	\item[known-flags:] A flag named \texttt{CTR}, which indicates
		that a Tor relay should be used for CT-auditing purposes.  The CTR
		criteria is to be a stable middle relay with some minimum bandwidth.
		\TODO{bw necessary?}
\end{description}
% - A CTR should be stable both to permit long-lived circuits to the CT logs and
% to increase the likelihood of them staying online.
% - The criteria of being a middle relay, as opposed to an exit relay, follows
% mainly from resource utilization considerations.  It is also about not making
% exit relays "more attractive targets" due to also storing SFOs.

\subsection{Tor Browser}
Similar to Chrome and Safari~\cite{chrome-policy,safari-policy}, we suggest that
Tor Browser should use an SCT-centric CT policy.  This means that a certificate
chain is accepted as valid if it is accompanied by a threshold of SCTs.  Such a
policy would ideally come from Mozilla directly (like many other components),
but at the time of writing there is no official CT policy that can be inherited
from Firefox.

If an SFO passes Tor Browser's CT policy, a biased coin is flipped based on the
current value of \texttt{ct-submit-pr}.  Should the outcome indicate auditing,
a CTR is sampled uniformly from the set of available CTRs and then the SFO is
submitted on a fresh independent circuit that is closed as soon as possible.  In
other words, at most one SFO is submitted per circuit.  In case that an SFO is
presented multiple times within the same tab, it is only considered for auditing
once.

%
% - close circuit asap to make it harder for an attacker to figure out which
% CTR received a submission (should it have access to a zero-day takeover).
% - clearly a submission circuit cannot be reused across tabs, but not doing
% so within tabs may (i) reduce the chance that the receiving CTR knows exactly
% which website was visited, and (ii) make sense because with small submission
% pr (<=1/10) it should be common to submit at most once per tab anyway.
%

\subsection{CTR}
A relay that is assigned the CTR flag accepts incoming SFO submissions on a
dedicated HTTP endpoint.  As such, we suggest using Tor's existing HTTP
DirServer as an extension point to interact with the tor daemon.  An auditing
process then runs somewhat periodically, ensuring that the received SFOs are
either merged into the logs or given attention to by the announced auditors.
Following from the threat of flushing, CTRs also publish additional health
metrics in the extra-info document.

\subsubsection{Submission Endpoint}
As outlined in detail below, a CTR listens for incoming SFO submissions on an
HTTP endpoint.  For example, it is possible to reuse the SCT feedback mechanism
that Nordberg~\emph{et~al.}~\cite{nordberg} defined.  At most one SFO is
expected per circuit.  Therefore, a submission should be rejected if it
contains more than one SFO (step~1).  A CTR should also reject a submission if
it contains no SCT from a recognized CT log, as there would be no STH available
in the Tor consensus to use while querying for inclusion (step~2).
If an SFO corresponds to a frequently visited website, it might already be
resolved or waiting to be resolved in a \emph{cache} or a \emph{buffer} of
pending SFOs (step~3).  Both the cache and the buffer of pending SFOs could be
managed by Tor's OOM, which takes care of similar resources such as DNS.  If an
SFO is neither resolved nor waiting to be resolved, an \texttt{audit\_after}
timestamp $t$ is computed.  Unless the current time is greater than $t$, the SFO
in question will not be audited despite being stored in the buffer of pending
SFOs (step~5).  The reason why an SFO is not audited immediately is two-fold.
First, adding a random delay in the order of minutes makes it harder for the log
to learn about real-time website visits.  Secondly, a log is not forced to add
an SCT's entry unless an MMD elapsed (discussed in Section~\ref{sec:todo}).

For each incoming SFO $s$:
\begin{enumerate}
	\item Return and error and stop if some SFO was already received over the
		current circuit.
	\item Return an error and stop if $s$ contains no SCT from a recognized log.
		Unrecognized SCTs are dropped. % otherwise can exploit for flush
	\item Check if $s$ is already cached or pending inclusion verification.
		If so, discard $s$ and stop without error.
	\item Select the first SCT in $s$ using lexicographical order and compute
		an \texttt{audit\_after} timestamp (Figure~\ref{fig:audit-after}).
	\item Store $s$ and its \texttt{audit\_after} timestamp in a buffer of
		pending SFOs that is managed by Tor's OOM.
\end{enumerate}

If memory becomes a scarce resource due to flushing, OOM should trigger and
delete SFOs \emph{at random}~\cite{nordberg}.  The impact of such bulk-deletes
are discussed in Section~\ref{sec:todo}.

\begin{figure}
	\centering
	\pseudocode[linenumbering, syntaxhighlight=auto]{%
		\textrm{t} \gets \mathsf{now}() \\
		\pcif \textrm{SCT.timestamp} + \textrm{MMD} + \textrm{C} >
				\textrm{t}:\\
			\pcind\textrm{t} \gets \mathsf{min}(
				\textrm{SCT.timestamp}, \textrm{t} +
				\textrm{MMD} +
				\textrm{C}
			)\\
			\textrm{t} \gets \textrm{t} + \mathsf{random\_delay}()
	}
	\caption{%
		docdoc;
		\TODO{C needed here? Or, better to have this in audit process with
		regards to available STHs?}
	}
	\label{fig:audit-after}
\end{figure}


\subsubsection{Auditing Process}
TODO: add context
\begin{enumerate}
	% TODO: distribution?
	\item\label{enm:backoff} Sample a delay in the order of a few minutes, then
		schedule a timer and wait until that time elapsed.
	\item\label{enm:audit-circuit} Establish a new circuit and connect to a
		randomly selected announced auditor in the Tor consensus.
	\item\label{enm:log-circuit} Establish a new circuit and use it for all
		subsequent log connections.  Connect to the logs when needed.
	\item\label{enm:audit-loop} Until there are no more SFOs such that their
		\texttt{audit\_after} timestamps are less than $\mathsf{now}()$:
		\begin{enumerate}
			% TODO: is sampled timeout justified?  Or just set the minimal one,
			% which is what we have data on..
			\item Select a random SCT from the current SFO.
			% TODO: what if we don't have a reference STH where the MMD elapsed?
			\item Set a query-timeout in the order of seconds and challenge the
				log to prove inclusion with regards to the most recent STH in
				the Tor consensus.
				\begin{itemize}
					\item On valid proof: cache the SFO in question by storing
						the first SCT in lexicographical order, then continue
						the loop from step~\ref{enm:audit-loop}.
						% TODO: H(sct) instead?
					\item On any other outcome: immediately send the entire SFO
						to the auditor from step~\ref{enm:audit-circuit}, then
						remove it from the buffer and break.
				\end{itemize}
		\end{enumerate}
	\item Close all circuits from steps~\ref{enm:audit-circuit}--%
		\ref{enm:log-circuit} and go to step~\ref{enm:backoff}.
\end{enumerate}

\subsubsection{Extra-Info Document}
The extra-info document tells us something about a relay's internal state of
affairs.  For example, \texttt{read-history} and \texttt{write-history} list how
many bytes were consumed throughout different time intervals.  To detect
flushing attempts and track CT overhead in Tor, we suggest that the following
metrics should be added:
\begin{description}
	\item[ct-submit-bytes:] Occurs at most once.  Interval width, followed by a
		list of received SFO bytes per interval.
	\item[ct-submit-count:] Occurs at most once.  Interval width, followed by a
		list of received SFO submission counts per interval.
	\item[ct-delete-count:] Occurs at most once.  Interval width, followed by a
		list of deleted SFO submissions per interval.
\end{description}

A CTR should generate a new descriptor and extra-info document if the most
current extra-info document had no deletions while the next one will have more
than a threshold.  This is \emph{in addition} to already existing criteria.

\subsection{Announced Auditors}
