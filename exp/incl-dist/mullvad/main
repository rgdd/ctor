#!/bin/bash

#
# Usage: ./main 2>&1 | tee main.log
#

BACKOFF=600 # seconds to wait until scheduling another job
TIMEOUT=10 # seconds to wait before killing an unresponsive connection
WAKEUP=10 # seconds to wait after starting Mullvad
DATA_DIR=data # path to store timestamped results

function main() {
	log_info "press ctrl+c to quit"
	while :; do
		job && log_info "sleeping: ${BACKOFF}s" && sleep $BACKOFF
	done
}

function job() {
	dir=$DATA_DIR/$(date +"%Y%m%d_%H%M%S")
	mkdir -p $dir
	log_info "created output directory: $dir"

	normal_ip=$(timeout $TIMEOUT curl ifconfig.me 2>/dev/null)
	if [[ -z $normal_ip ]]; then
		log_error "no connectivity"
		return 1
	fi

	make_config .tmp.mullvad.config
	log_info "created relay configs: $(cat .tmp.mullvad.config | wc -l)"

	log_info "experiment started: $(date)"
	while read config; do
		mullvad relay set location $config
		mullvad connect
		sleep $WAKEUP # ensure that mullvad got some time to start

		vpn_ip=$(timeout $TIMEOUT curl ifconfig.me 2>/dev/null)
		if [[ -z $vpn_ip ]]; then
			log_error "no connectivity for config: $config"
			continue
		fi

		if [[ $normal_ip == $vpn_ip ]]; then
			log_error "expected vpn to be used for config: $config"
			continue
		fi

		log_info "using config: $config ($vpn_ip)"
		python3 rttct.py -i scthash.json -o "$dir/$config.json" -t $TIMEOUT
		mullvad disconnect
	done < .tmp.mullvad.config
	rm -f .tmp.mullvad.config
	log_info "experiment ended: $(date)"
}

function make_config() {
	config_path=$1
	new_country="yes"
	mullvad relay list > .tmp.mullvad.relay.list
	while read line; do
		if [[ $new_country == "yes" ]]; then
			country_code=$(echo $line | sed 's/^.*(//g' | sed 's/).*$//g')
			new_country="no"
			continue
		fi

		if [[ -z $line ]]; then
			new_country="yes"
			continue
		fi

		if [[ -z $(echo $line | grep "@") ]]; then
			continue # find more relays
		fi

		relay_code=$(echo $line | sed 's/^.*(//g' | sed 's/).*$//g')
		echo "$country_code $relay_code" >> $config_path
	done < .tmp.mullvad.relay.list
	rm -f .tmp.mullvad.relay.list
}

function log_info() {
	echo "[Info] $@" >&2
}

function log_error() {
	echo "[Error] $@" >&2
}

main
